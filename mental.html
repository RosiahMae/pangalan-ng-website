<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Support Center</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        @keyframes ami-speak {
            0%, 100% { transform: scale(1.0); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        .animate-ami-speak {
            animation: ami-speak 1s infinite alternate;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Main Application Container -->
    <div id="app" class="relative">
        <header class="sticky top-0 z-50 bg-white shadow-lg p-4 flex justify-between items-center border-b border-gray-200">
            <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-600 mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                <h1 class="text-2xl font-bold text-gray-800">Student Support Center</h1>
            </div>
            <span id="user-role-display" class="px-3 py-1 bg-indigo-100 text-indigo-600 rounded-full font-medium capitalize">Student View</span>
        </header>

        <main id="dashboard-container" class="p-4 md:p-8">
            <div class="flex items-center justify-center h-64">
                <p class="text-xl text-gray-500">Loading Student Dashboard...</p>
            </div>
        </main>
    </div>

    <!-- Emergency Contact Button and Modal -->
    <button id="emergency-button" class="hidden fixed bottom-6 right-6 z-50 p-4 text-white font-bold rounded-full shadow-2xl bg-red-600 hover:bg-red-700 transition-all duration-300 transform hover:scale-105" aria-label="Emergency Help" onclick="showEmergencyModal()">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
    </button>
    <div id="emergency-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 space-y-4 border-4 border-red-500 transform transition-all duration-300 scale-95 opacity-0" id="emergency-modal-content">
            <h4 class="text-2xl font-extrabold text-red-600">EMERGENCY: Need Immediate Help?</h4>
            <p class="text-gray-700">If you are in danger or crisis, please use one of the contacts below immediately. Your safety is the priority.</p>
            <div class="space-y-3">
              <a href="tel:0000000000" class="flex items-center p-3 bg-red-100 rounded-lg font-semibold text-red-700 hover:bg-red-200 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" viewBox="0 0 24 24" fill="currentColor"><path d="M6.62 10.79l2.49 2.49c-1.12 1.94-2.88 3.7-4.82 4.82l-2.49-2.49a.8.8 0 0 0-.8-.18c-.37.13-1.6.43-2.3.93-.7.5-1.1 1.2-1.1 2s.4 1.5.93 2.3c.5.7.97 1.93 1.1 2.3l2.49 2.49c.67.67 1.55 1.05 2.53 1.05s1.86-.38 2.53-1.05l2.49-2.49c1.94-1.12 3.7-2.88 4.82-4.82l2.49-2.49a.8.8 0 0 0-.18-.8c-.13-.37-.43-1.6-.93-2.3-.5-.7-1.2-1.1-2-1.1s-1.5.4-2.3.93c-.7.5-1.93.97-2.3 1.1a.8.8 0 0 0-.18.8zM20 12c0 2.21-1.79 4-4 4s-4-1.79-4-4 1.79-4 4-4 4 1.79 4 4z"/></svg>
                School Guidance Office (000-000-0000)
              </a>
              <a href="tel:911" class="flex items-center p-3 bg-red-100 rounded-lg font-semibold text-red-700 hover:bg-red-200 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-11h4v4h-4v-4z"/></svg>
                National Hotline (e.g., 911 / Local Emergency)
              </a>
            </div>
            <button onclick="hideEmergencyModal()" class="w-full py-2 border border-red-600 text-red-600 font-semibold rounded-lg hover:bg-red-50 transition-colors mt-4">
              Close and Return to App
            </button>
        </div>
    </div>


    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, orderBy, onSnapshot, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL CONFIGURATION AND VARIABLES ---
        const ROLES = { STUDENT: 'student', COUNSELOR: 'counselor', ADMIN: 'admin' };
        const MOODS = [
            { icon: 'üòä', name: 'Happy', value: 5, color: 'bg-green-100 text-green-700 ring-green-500' },
            { icon: 'üòê', name: 'Neutral', value: 4, color: 'bg-yellow-100 text-yellow-700 ring-yellow-500' },
            { icon: 'üòü', name: 'Anxious', value: 3, color: 'bg-orange-100 text-orange-700 ring-orange-500' },
            { icon: 'üòî', name: 'Sad', value: 2, color: 'bg-red-100 text-red-700 ring-red-500' },
            { icon: 'üò©', name: 'Distressed', value: 1, color: 'bg-purple-100 text-purple-700 ring-purple-500' },
        ];
        
        const API_KEY = "";
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-mental-health-app';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        let userId = null;
        let userRole = ROLES.STUDENT; // Default role for this specific file
        let chatHistory = [];
        let chatSubscription = null;

        // --- UTILITY & MODAL FUNCTIONS ---

        async function exponentialBackoffFetch(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    if (response.status === 429 && i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                } catch (error) {
                    if (i === retries - 1) throw error;
                    console.warn(`Fetch attempt ${i + 1} failed, retrying...`);
                }
            }
        }
        
        const getUserCollectionPath = (collectionName) => `artifacts/${appId}/users/${userId}/${collectionName}`;

        function showEmergencyModal() {
            const modal = document.getElementById('emergency-modal');
            const content = document.getElementById('emergency-modal-content');
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }
        window.showEmergencyModal = showEmergencyModal;
        
        function hideEmergencyModal() {
            const modal = document.getElementById('emergency-modal');
            const content = document.getElementById('emergency-modal-content');
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        window.hideEmergencyModal = hideEmergencyModal;


        // --- FIREBASE AND AUTHENTICATION ---

        async function setupFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // For a focused dashboard, we set the role directly
                        userRole = ROLES.STUDENT; 
                        renderApp();
                    } else {
                        userId = crypto.randomUUID();
                        userRole = ROLES.STUDENT; 
                        renderApp();
                    }
                    document.getElementById('emergency-button').classList.remove('hidden');
                });
            } catch (e) {
                console.error("Firebase Setup Error:", e);
                userId = 'fallback-user-' + crypto.randomUUID().substring(0, 8);
                userRole = ROLES.STUDENT;
                document.getElementById('dashboard-container').innerHTML = '<p class="text-xl text-red-500">Error: Could not connect to Firebase. Using offline simulation for chat.</p>';
                renderApp();
            }
        }

        // --- AI CHATBOT LOGIC ---

        async function saveMessage(text, role) {
            if (!db || !userId) return;
            try {
                await addDoc(collection(db, getUserCollectionPath('chat_logs')), {
                    text,
                    role,
                    timestamp: new Date(),
                });
            } catch (e) {
                console.error("Error saving message:", e);
            }
        }

        function setupChatListener() {
            if (chatSubscription) chatSubscription();
            if (!db || !userId) return;

            const q = query(collection(db, getUserCollectionPath('chat_logs')), orderBy('timestamp', 'asc'));
            
            chatSubscription = onSnapshot(q, (snapshot) => {
                chatHistory = snapshot.docs.map(doc => doc.data());
                renderChatMessages();
            }, (error) => {
                console.error("Error listening to chat logs:", error);
            });
        }

        function renderChatMessages() {
            const chatBox = document.getElementById('chat-messages');
            if (!chatBox) return;

            if (chatHistory.length === 0) {
                 chatBox.innerHTML = `
                    <div class="text-center p-12 text-gray-500 bg-gray-50 rounded-lg">
                        <p class="text-lg font-semibold">Welcome! Kumusta ka?</p>
                        <p>I am **Ami**, your mental health support AI. I listen and respond in English or Tagalog.</p>
                        <p class="text-sm mt-2 text-indigo-500">Try saying "I feel stressed" or "May problema ako sa pag-aaral."</p>
                    </div>
                `;
            } else {
                chatBox.innerHTML = chatHistory.map(msg => `
                    <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-[75%] p-3 rounded-xl shadow-md transition-all duration-200 ${
                            msg.role === 'user' 
                                ? 'bg-indigo-600 text-white rounded-br-none' 
                                : 'bg-gray-100 text-gray-800 rounded-tl-none'
                        }">
                            ${msg.text}
                        </div>
                    </div>
                `).join('');
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const inputField = document.getElementById('chat-input');
            const sendButton = document.getElementById('chat-send-button');
            const userMessage = inputField.value.trim();
            if (!userMessage) return;

            inputField.value = '';
            sendButton.disabled = true;
            sendButton.textContent = 'Thinking...';
            document.getElementById('ami-avatar').classList.add('animate-ami-speak', 'bg-gray-400');

            await saveMessage(userMessage, 'user');

            const systemInstruction = `
                You are 'Ami', a highly empathetic and supportive AI mental health chatbot for students.
                Goals: Provide comfort, active listening, and coping strategies.
                Bilingual: You MUST understand and respond fluently in **English and Tagalog/Filipino**.
                Crisis Detection: If the user expresses severe distress, suicide ideation, or immediate danger, you MUST respond with a **crisis alert** starting with the exact phrase "CRISIS ALERT: Please prioritize safety." followed by immediate, directive advice to use the Emergency Contact button and seek human help.
                Keep responses concise and focused on validating feelings.
            `;
            
            const payload = {
                contents: chatHistory.map(msg => ({
                    role: msg.role === 'ai' ? 'model' : 'user',
                    parts: [{ text: msg.text }]
                })).concat([{ role: 'user', parts: [{ text: userMessage }] }]),
                systemInstruction: { parts: [{ text: systemInstruction }] },
                tools: [{ "google_search": {} }],
            };

            let aiResponseText = 'I am having trouble connecting right now, but I hear you. Please try again or reach out to a counselor.';

            try {
                const response = await exponentialBackoffFetch(`${GEMINI_API_URL}?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    aiResponseText = text;
                }
            } catch (error) {
                console.error("AI Chatbot API Error:", error);
            }
            
            await saveMessage(aiResponseText, 'ai');

            sendButton.disabled = false;
            sendButton.textContent = 'Send';
            document.getElementById('ami-avatar').classList.remove('animate-ami-speak', 'bg-gray-400');
            document.getElementById('ami-avatar').classList.add('bg-indigo-400');

            if (aiResponseText.startsWith("CRISIS ALERT:")) {
                showEmergencyModal();
            }
        }
        window.handleChatSubmit = handleChatSubmit;


        // --- MODULE RENDERING FUNCTIONS ---

        function renderAiChatbot() {
            return `
                <div class="flex flex-col h-full bg-white shadow-xl rounded-xl">
                    <header class="flex items-center p-4 border-b bg-indigo-50 rounded-t-xl">
                        <div id="ami-avatar" class="flex flex-col items-center justify-center p-3 rounded-full shadow-lg transition-all duration-300 w-16 h-16 bg-indigo-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-bold text-indigo-800">Ami - Mental Health Chatbot</h3>
                            <p class="text-sm text-gray-500">I'm here to listen, in English or Tagalog.</p>
                        </div>
                    </header>
                    
                    <div id="chat-messages" class="flex-1 p-4 space-y-4 overflow-y-auto">
                        <!-- Chat messages rendered here by JS -->
                    </div>

                    <form onsubmit="handleChatSubmit(event)" class="p-4 border-t bg-gray-50 rounded-b-xl">
                        <div class="flex space-x-3">
                            <input
                                type="text"
                                id="chat-input"
                                placeholder="Tell Ami how you're feeling..."
                                class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-200"
                            />
                            <button
                                type="submit"
                                id="chat-send-button"
                                class="px-6 py-3 text-white bg-indigo-600 rounded-lg font-semibold hover:bg-indigo-700 transition-colors disabled:opacity-50"
                            >
                                Send
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        function renderEmotionalCheckIns() {
            window.logMood = async (moodName, moodValue) => {
                const notes = document.getElementById('mood-notes').value.trim();
                const logStatusEl = document.getElementById('mood-log-status');
                logStatusEl.textContent = 'Logging...';
                logStatusEl.classList.remove('text-green-600', 'text-red-600');

                if (!db || !userId) {
                    logStatusEl.textContent = 'Error: Not connected to database.';
                    logStatusEl.classList.add('text-red-600');
                    return;
                }
                try {
                    await addDoc(collection(db, getUserCollectionPath('mood_logs')), {
                        mood: moodName,
                        value: moodValue,
                        notes: notes,
                        timestamp: new Date(),
                    });
                    logStatusEl.textContent = 'Mood logged successfully!';
                    logStatusEl.classList.add('text-green-600');
                    document.getElementById('mood-notes').value = '';
                } catch (error) {
                    logStatusEl.textContent = 'Failed to log mood.';
                    logStatusEl.classList.add('text-red-600');
                    console.error("Error logging mood:", error);
                }
                setTimeout(() => logStatusEl.textContent = '', 3000);
            };

            return `
                <div class="p-6 bg-white rounded-xl shadow-lg border border-yellow-200">
                    <h3 class="text-xl font-bold text-yellow-700 mb-4">Emotional Check-in & Journal</h3>
                    <p class="text-gray-600 mb-4">How are you feeling right now?</p>
                    
                    <div class="grid grid-cols-5 gap-2 mb-4">
                        ${MOODS.map(mood => `
                            <button
                                key="${mood.name}"
                                onclick="logMood('${mood.name}', ${mood.value})"
                                class="flex flex-col items-center p-2 md:p-3 rounded-lg border-2 transition-all duration-200 ${mood.color} border-transparent hover:ring-2 hover:${mood.color} active:ring-4 active:ring-opacity-75"
                            >
                                <span class="text-2xl md:text-3xl">${mood.icon}</span>
                                <span class="text-xs font-semibold mt-1 hidden sm:block">${mood.name}</span>
                            </button>
                        `).join('')}
                    </div>

                    <textarea
                        id="mood-notes"
                        placeholder="Optional: Write about why you feel this way (personal journal)."
                        rows="2"
                        class="w-full p-3 border border-gray-300 rounded-lg mb-3"
                    ></textarea>
                    <p id="mood-log-status" class="text-sm font-medium h-4"></p>
                </div>
            `;
        }

        function renderResourceCenter() {
            // UPDATED LINKS HERE
            const resources = [
                { title: "5 Tips for Managing Exam Stress", category: "Stress", link: "stress_tips.html" },
                { title: "Understanding Anxiety: A Quick Guide", category: "Anxiety", link: "anxiety_guide.html" },
                { title: "The Power of Mindfulness (Video)", category: "Video", link: "mindfulness_video.html" },
            ];
            return `
                <div class="p-6 bg-white rounded-xl shadow-lg border border-green-200">
                    <h3 class="text-xl font-bold text-green-700 mb-4">Psychological Resource Center</h3>
                    <p class="text-gray-600 mb-4">Articles, videos, and tips for better self-care.</p>
                    <div class="space-y-3">
                        ${resources.map((res) => `
                            <a href="${res.link}" target="_blank" rel="noopener noreferrer" class="block p-3 border border-gray-200 rounded-lg hover:bg-green-50 transition-colors flex justify-between items-center">
                                <div>
                                    <p class="font-semibold text-gray-800">${res.title}</p>
                                    <span class="text-xs text-green-600 bg-green-100 px-2 py-0.5 rounded-full">${res.category}</span>
                                </div>
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-green-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7h10v10M7 17l10-10"/></svg>
                            </a>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function renderAppointmentBooking() {
            window.requestAppointment = (e) => {
                e.preventDefault();
                const statusEl = document.getElementById('appt-status');
                statusEl.textContent = 'Requesting...';
                
                setTimeout(() => {
                    statusEl.textContent = 'Appointment request submitted! A counselor will confirm shortly.';
                    statusEl.classList.remove('text-red-600');
                    statusEl.classList.add('text-green-600');
                }, 1500);
            };

            return `
                <div class="p-6 bg-white rounded-xl shadow-lg border border-blue-200">
                    <h3 class="text-xl font-bold text-blue-700 mb-4">Appointment Booking</h3>
                    <p class="text-gray-600 mb-4">Schedule a confidential session with a school professional.</p>
                    
                    <form onsubmit="requestAppointment(event)" class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Counselor</label>
                            <select class="mt-1 block w-full p-3 border border-gray-300 rounded-lg">
                                <option>Ms. Dela Cruz (Available)</option>
                                <option>Mr. Santos (Limited Slots)</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Date</label>
                                <input type="date" required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg"/>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Time</label>
                                <select required class="mt-1 block w-full p-3 border border-gray-300 rounded-lg">
                                    <option value="">Select Time</option>
                                    <option>10:00 AM</option>
                                    <option>1:00 PM</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
                            Request Session
                        </button>
                    </form>
                    <p id="appt-status" class="mt-3 text-sm text-center font-medium h-4"></p>
                </div>
            `;
        }

        function renderConfidentialFeedback() {
            window.submitFeedback = () => {
                const feedbackStatusEl = document.getElementById('feedback-status');
                feedbackStatusEl.textContent = 'Submitting...';
                
                setTimeout(() => {
                    feedbackStatusEl.textContent = 'Feedback submitted. Thank you!';
                    feedbackStatusEl.classList.add('text-green-600');
                }, 1000);
            };

            return `
                <div class="p-6 bg-white rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-bold text-gray-700 mb-4">Confidential Feedback</h3>
                    <p class="text-sm text-gray-500 mb-4">Submit concerns or system suggestions anonymously.</p>
                    <textarea
                        placeholder="Your feedback..."
                        rows="2"
                        class="w-full p-3 border border-gray-300 rounded-lg mb-3"
                    ></textarea>
                    <button onclick="submitFeedback()" class="w-full py-2 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition-colors">
                        Submit Anonymously
                    </button>
                     <p id="feedback-status" class="mt-3 text-sm text-center font-medium h-4"></p>
                </div>
            `;
        }
        
        // --- MAIN RENDER FUNCTION ---

        function renderStudentDashboard() {
            if (chatSubscription) chatSubscription();
            setupChatListener();

            const html = `
                <h2 class="text-3xl font-extrabold text-indigo-800 mb-6">Student Support Center</h2>
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 md:gap-8">
                    <!-- AI Chatbot Support -->
                    <div class="xl:col-span-2 h-[80vh] flex flex-col">
                        ${renderAiChatbot()}
                    </div>

                    <!-- Side Panel Modules -->
                    <div class="xl:col-span-1 space-y-6 md:space-y-8">
                        ${renderEmotionalCheckIns()}
                        ${renderAppointmentBooking()}
                        ${renderResourceCenter()}
                        ${renderConfidentialFeedback()}
                    </div>
                </div>
            `;
            document.getElementById('dashboard-container').innerHTML = html;
        }

        function renderApp() {
            renderStudentDashboard();
        }

        // Initialize on load
        window.onload = setupFirebase;
    </script>
</body>
</html>
